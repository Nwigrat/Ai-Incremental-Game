<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>AI Tycoon ‚Äî Incremental Clicker (Web)</title>
<style>
  :root{
    --bg:#0f141b; --fg:#e8eef6; --panel:#1a212b; --panel2:#141a22; --acc:#2b3442; --ok:#4ad295; --warn:#f6c85f; --bad:#ef6f6c;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;touch-action:manipulation}
  header{display:flex;flex-wrap:wrap;gap:12px 16px;align-items:center;padding:clamp(10px,1.8vh,16px) max(12px,env(safe-area-inset-left)) max(10px,env(safe-area-inset-right));background:linear-gradient(180deg,var(--panel),var(--panel2));border-bottom:1px solid #0008;position:sticky;top:0;z-index:10}
  header h1{font-size:clamp(16px,2.6vw,18px);margin:0;white-space:nowrap}
  .stat{margin-right:8px;white-space:nowrap;font-size:clamp(12px,2.4vw,15px)}
  .stat.hide-xs{display:none}
  .ipo{margin-left:auto;display:flex;align-items:center;gap:8px;min-width:220px}
  .ipo label{font-size:12px;opacity:.8}
  progress{accent-color:var(--ok);height:10px;width:min(44vw,280px)}
  /* IPO progress specific: make it slimmer */
  #ipoProg{height:6px;width:min(34vw,180px);border-radius:6px;overflow:hidden}
  #ipoPct{font-size:12px;margin-left:8px;opacity:0.9}

  main{display:grid;grid-template-columns: 1.1fr 1fr; gap:16px; padding:16px;}
  .card{background:var(--panel); border:1px solid #0008; border-radius:14px; padding:12px;}
  .title{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
  button{background:#2c3950;border:1px solid #000; color:var(--fg); padding:12px 14px; border-radius:12px; cursor:pointer; min-height:44px}
  button:disabled{opacity:.5;cursor:not-allowed}
  .shop{display:flex;flex-direction:column;gap:8px;max-height:48vh;overflow:auto;padding-right:4px}
  .row{display:flex;align-items:center;gap:8px;padding:10px;border-radius:12px;background:var(--panel2);border:1px solid #0006}
  .row .grow{flex:1;min-width:160px}
  .row .muted{opacity:.7}
  .tabs{display:flex;gap:6px;margin:8px 0 10px;flex-wrap:wrap}
  .tab{padding:8px 10px;border-radius:10px;background:var(--panel2);border:1px solid #0006;cursor:pointer;user-select:none}
  .tab.active{outline:2px solid #3d4f6b}
  .hidden{display:none}
  footer{position:sticky;bottom:0;background:linear-gradient(0deg,var(--panel),var(--panel2));border-top:1px solid #0008;padding:8px 12px calc(8px + env(safe-area-inset-bottom));color:#c9d4e5;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .pill{padding:4px 10px;border-radius:999px;background:#223041;border:1px solid #0006;font-size:13px}
  a{color:#9ecbff}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .ach{display:flex;gap:8px;align-items:center}

  /* Lore card styling */
  #loreLayer{position:fixed;left:0;top:0;width:100%;height:100%;pointer-events:none;z-index:9998}
  .lore-card{
    position:fixed;
    left:50%;top:50%;
    transform:translate(-50%,-50%) scale(0.9);
    background:var(--panel);
    border:1px solid #456;
    border-radius:16px;
    padding:20px;
    width:min(500px, 90vw);
    box-shadow:0 4px 32px #0008;
    opacity:0;
    transition:all 0.3s ease-out;
  }
  .lore-card.show{
    opacity:1;
    transform:translate(-50%,-50%) scale(1);
  }
  .lore-card .title{
    font-size:18px;
    margin-bottom:12px;
    color:var(--ok);
  }
  .lore-card .body{
    line-height:1.5;
    margin-bottom:16px;
  }
  .lore-card button{
    float:right;
    padding:8px 16px;
    pointer-events:auto;
  }
</style>
</head>
<body>
  <header>
    <h1>üß† AI Tycoon ‚Äî Web</h1>
    <div class="stat" id="statFunding">Funding: $0</div>
  <div class="stat" id="statRPS">RPS: $0/s</div>
  <div class="stat hide-xs" id="statEPS">EPS: $0/s</div>
  <div class="stat" id="statUpgMult">Upg: x1.00</div>
  <div class="stat" id="statRep">Rep: 0 (x1.0)</div>
    <div class="ipo">
  <label for="ipoProg">IPO</label>
  <progress id="ipoProg" max="1" value="0"></progress>
  <span id="ipoPct">0%</span>
  <button id="btnPrestige" aria-label="Go Public">Go Public</button>
    </div>
  </header>

  <main class="grid2">
    <section class="card">
      <div class="title"><strong>Play</strong><span id="clickInfo" class="pill">+ $1 / click</span></div>
      <button id="btnClick" style="width:100%;font-size:20px">üöÄ Ship Feature</button>
      <div class="tabs" role="tablist" aria-label="Play Tabs">
        <div class="tab active" data-tab="quickGens" role="tab" aria-selected="true">Quick Generators</div>
        <div class="tab" data-tab="quickUpg" role="tab" aria-selected="false">Quick Upgrades</div>
        <div class="tab" data-tab="stats" role="tab" aria-selected="false">Stats</div>
      </div>
      <div id="quickGens" class="shop" role="region" aria-label="Quick Generators"></div>
      <div id="quickUpg" class="shop hidden" role="region" aria-label="Quick Upgrades"></div>
      <div id="stats" class="hidden" role="region" aria-label="Stats">
        <p id="statsBody" style="margin:8px 0 0"></p>
      </div>
    </section>

    <section class="card">
      <div class="title"><strong>Management</strong></div>
      <div class="tabs" role="tablist" aria-label="Management Tabs">
        <div class="tab active" data-tab="tabGens" role="tab" aria-selected="true">Generators</div>
        <div class="tab" data-tab="tabUpg" role="tab" aria-selected="false">Upgrades</div>
        <div class="tab" data-tab="tabAch" role="tab" aria-selected="false">Achievements</div>
        <div class="tab" data-tab="tabSettings" role="tab" aria-selected="false">Settings</div>
      </div>
      <div id="tabGens" class="shop" role="region" aria-label="Generators"></div>
      <div id="tabUpg" class="shop hidden" role="region" aria-label="Upgrades"></div>
      <div id="tabAch" class="shop hidden" role="region" aria-label="Achievements"></div>
      <div id="tabSettings" class="hidden" role="region" aria-label="Settings">
        <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:8px 0">
          <label for="fmt">Number format:</label>
          <select id="fmt">
            <option value="compact">Compact</option>
            <option value="full">Full</option>
          </select>
          <label for="autosave" style="margin-left:12px">Autosave (s):</label>
          <input type="number" id="autosave" min="5" max="600" value="30" style="width:90px">
          <button id="btnExport">Export Save</button>
          <input type="file" id="importFile" accept="application/json" style="display:none"/>
          <button id="btnImport">Import Save</button>
          <button id="btnReset" style="margin-left:auto;background:#4a1010">Hard Reset</button>
        </div>
      </div>
    </section>
  </main>

  <footer>
    <span id="status">Welcome to AI Tycoon Web. Tap the rocket to ship features.</span>
    <span class="pill" id="autosavePill">Autosave: 30s</span>
  </footer>

  <!-- Animation layer for click effects -->
  <div id="animLayer" aria-hidden="true"></div>
  
  <!-- Lore card layer -->
  <div id="loreLayer" aria-hidden="true"></div>

<script>
(function(){
  // ------------------ Content ------------------
  const Generators = {
    intern:      { key:'intern',      name:'Intern Developer',    baseCost:15,     costMult:1.15, baseEPS:0.1,  owned:0, unlockedAt:0,     desc:'Sometimes compiles.' },
    gpu:         { key:'gpu',         name:'GPU Rig',             baseCost:100,    costMult:1.15, baseEPS:1.0,  owned:0, unlockedAt:50,    desc:'Gaming GPUs moonlighting.' },
    researcher:  { key:'researcher',  name:'Research Scientist',   baseCost:650,    costMult:1.17, baseEPS:7.5,  owned:0, unlockedAt:300,   desc:'SOTA trick, viral arXiv.' },
    datacenter:  { key:'datacenter',  name:'Mini Datacenter',      baseCost:4200,   costMult:1.18, baseEPS:45,   owned:0, unlockedAt:2000,  desc:'A few racks, lots of heat.' },
    foundation:  { key:'foundation',  name:'Foundation Model Team',baseCost:35000,  costMult:1.20, baseEPS:320,  owned:0, unlockedAt:20000, desc:'Mind‚Äëblowing demos.' },
    planetary:   { key:'planetary',   name:'Planet‚ÄëScale Inference',baseCost:250000, costMult:1.22, baseEPS:2400, owned:0, unlockedAt:150000,desc:'Edge accelerators everywhere.' },
    nebula:      { key:'nebula',      name:'Nebula Supercluster',  baseCost:2000000, costMult:1.25, baseEPS:18000, owned:0, unlockedAt:1000000, desc:'Massive clustered inference.' },
    exascale:    { key:'exascale',    name:'Exascale Cluster',     baseCost:12000000, costMult:1.27, baseEPS:120000, owned:0, unlockedAt:5000000, desc:'Exascale-level throughput.' },
    global_mesh: { key:'global_mesh', name:'Global Mesh Fabric',   baseCost:80000000, costMult:1.30, baseEPS:800000, owned:0, unlockedAt:50000000, desc:'Planetary-wide inference fabric.' },
    cluster_palace: { key:'cluster_palace', name:'Cluster Palace',     baseCost:300000000, costMult:1.32, baseEPS:3500000, owned:0, unlockedAt:200000000, desc:'Massive cluster with specialized chips.' },
    quantum_core:   { key:'quantum_core',   name:'Quantum Core',       baseCost:1200000000, costMult:1.35, baseEPS:18000000, owned:0, unlockedAt:900000000, desc:'Quantum-assisted inference.' },
    hivemind:       { key:'hivemind',       name:'Hivemind Array',     baseCost:6000000000, costMult:1.38, baseEPS:90000000, owned:0, unlockedAt:3000000000, desc:'Collective multi-agent fabric.' },
    autofab:        { key:'autofab',        name:'Autofabricator',     baseCost:25000000000, costMult:1.40, baseEPS:480000000, owned:0, unlockedAt:10000000000, desc:'Automated hardware and deployment.' },
    synapse_farm:   { key:'synapse_farm',   name:'Synapse Farm',       baseCost:1e11, costMult:1.42, baseEPS:2.4e9, owned:0, unlockedAt:5e10, desc:'Neuromorphic data centers.' },
    orbital_armada: { key:'orbital_armada', name:'Orbital Armada',     baseCost:6e11, costMult:1.45, baseEPS:1.2e10, owned:0, unlockedAt:2e11, desc:'Space-based compute nodes.' },
    ai_governor:    { key:'ai_governor',    name:'AI Governor',        baseCost:3e12, costMult:1.48, baseEPS:6e10, owned:0, unlockedAt:1e12, desc:'Policy & orchestration layer.' },
    terraform_net:  { key:'terraform_net',  name:'Terraform Network',  baseCost:1.5e13, costMult:1.5, baseEPS:3.2e11, owned:0, unlockedAt:5e12, desc:'Infrastructure shaping network.' },
    singularity_hub: { key:'singularity_hub', name:'Singularity Hub',   baseCost:8e13, costMult:1.55, baseEPS:1.6e12, owned:0, unlockedAt:2e13, desc:'Beyond-exascale emergent compute.' },
    meta_cloud:     { key:'meta_cloud',     name:'Meta Cloud',         baseCost:4e14, costMult:1.6, baseEPS:8e12, owned:0, unlockedAt:8e13, desc:'Cloud of clouds ‚Äî near limitless.' },
  };

  const Upgrades = {
    click_hype:   { key:'click_hype',   name:'Launch Hype Site',       cost:50,     desc:'+2 click power.',           mult:1.0, addClick:2, requires:{} , purchased:false },
    global_brand: { key:'global_brand', name:'Global Brand Deal',      cost:1000,   desc:'x1.5 production.',           mult:1.5, addClick:0, requires:{intern:10}, purchased:false },
    tensor_cores: { key:'tensor_cores', name:'Tensor Cores Everywhere',cost:4000,   desc:'x1.8 production.',           mult:1.8, addClick:0, requires:{gpu:10}, purchased:false },
    paper_rec:    { key:'paper_rec',    name:'SOTA Paper + Recsys',    cost:20000,  desc:'x2.2 production.',           mult:2.2, addClick:0, requires:{researcher:10}, purchased:false },
    moe_scaling:  { key:'moe_scaling',  name:'MoE Scaling Laws',       cost:120000, desc:'x2.5 production.',           mult:2.5, addClick:0, requires:{foundation:5}, purchased:false },
    community_models: { key:'community_models', name:'Community Models',    cost:500000,  desc:'x1.4 production (open ecosystem).', mult:1.4, addClick:0, requires:{foundation:10}, purchased:false },
    ops_automation:   { key:'ops_automation',   name:'Ops Automation',      cost:2000000, desc:'x1.6 production (automation).', mult:1.6, addClick:0, requires:{datacenter:10}, purchased:false },
    federated_clients: { key:'federated_clients', name:'Federated Clients',  cost:10000000, desc:'x1.8 production (edge aggregation).', mult:1.8, addClick:0, requires:{planetary:10}, purchased:false },
    auto_synthesis:   { key:'auto_synthesis',   name:'Auto Synthesis',      cost:50000000, desc:'x2.0 production (auto‚Äëengineering).', mult:2.0, addClick:0, requires:{nebula:5}, purchased:false },
    market_domination: { key:'market_domination', name:'Market Domination',   cost:250000000, desc:'x3.0 production (global reach).', mult:3.0, addClick:0, requires:{global_mesh:2}, purchased:false },
  hyperconductor:    { key:'hyperconductor',    name:'Hyperconductor Grids', cost:1e9,      desc:'x1.5 production (efficient interconnect).', mult:1.5, addClick:0, requires:{exascale:3}, purchased:false },
  zero_copy_ai:      { key:'zero_copy_ai',      name:'Zero-Copy AI',        cost:5e9,      desc:'x1.6 production (memory efficiency).', mult:1.6, addClick:0, requires:{exascale:6}, purchased:false },
  planetary_resonance:{ key:'planetary_resonance',name:'Planetary Resonance',  cost:6e10,     desc:'x1.8 production (synchronized clusters).', mult:1.8, addClick:0, requires:{planetary:20}, purchased:false },
  holo_optimizer:    { key:'holo_optimizer',    name:'Holo Optimizer',       cost:3e11,     desc:'x2.2 production (compiler-level boosts).', mult:2.2, addClick:0, requires:{nebula:10}, purchased:false },
  autonomy_stack:    { key:'autonomy_stack',    name:'Autonomy Stack',       cost:1e12,     desc:'x2.5 production (self-managing systems).', mult:2.5, addClick:0, requires:{hivemind:3}, purchased:false },
  terraformor_ai:    { key:'terraformor_ai',    name:'Terraformor AI',       cost:5e12,     desc:'x3.0 production (infrastructure shaping).', mult:3.0, addClick:0, requires:{terraform_net:2}, purchased:false },
  singularity_core:  { key:'singularity_core',  name:'Singularity Core',     cost:2e13,     desc:'x4.0 production (emergent scaling).', mult:4.0, addClick:0, requires:{singularity_hub:1}, purchased:false },
  meta_orchestrator:  { key:'meta_orchestrator',  name:'Meta Orchestrator',    cost:1e14,     desc:'x5.0 production (global orchestration).', mult:5.0, addClick:0, requires:{meta_cloud:1}, purchased:false },
  ethical_shield:     { key:'ethical_shield',     name:'Ethical Shield',       cost:5e14,     desc:'x1.25 production (regulatory stability).', mult:1.25, addClick:0, requires:{ai_governor:1}, purchased:false },
  };

  // Lore entries mapped to milestones
  const Lore = {
    startup: {
      title: "The Garage Days",
      body: "Your journey begins in a small garage, armed with nothing but a laptop and a vision. The air is thick with the smell of coffee and determination. You've heard the whispers about AI changing the world - now it's your turn to be part of that change."
    },
    first_gpu: {
      title: "Gaming Hardware, Serious Business",
      body: "Repurposing gaming GPUs for AI training - it's not pretty, but it works. The constant whir of fans and the warm glow of status LEDs fill your workspace. Your neighbors are starting to complain about the power bills, but you're too excited about the training results to care."
    },
    research_milestone: {
      title: "Breakthrough Paper",
      body: "Your team's research paper hits the front page of arXiv. The comment section is a battlefield, but the metrics don't lie. You've found something new, something important. The big labs are starting to notice."
    },
    datacenter_era: {
      title: "From Garage to Datacenter",
      body: "The first rack of servers arrives at your new datacenter. The scale is different here - measured in petaflops instead of gigaflops. As you walk through the cold aisles, you realize: this is no longer just a startup. This is becoming something more."
    },
    foundation_breakthrough: {
      title: "The Foundation Model",
      body: "Your foundation model shows signs of emergent behavior nobody predicted. Late at night, reviewing the training logs, you see patterns that shouldn't be there. The model is learning things you never taught it. Both exciting and terrifying."
    },
    planetary_scale: {
      title: "Going Global",
      body: "Edge devices across the planet now run your inference models. Every smartphone, every IoT device, every connected car - they're all part of your network now. The network effect is exponential, and the data flows like rivers."
    },
    quantum_awakening: {
      title: "Quantum Horizons",
      body: "The quantum core spins up for the first time. Classical bits yield to qubits, and the possibilities explode. In the quantum realm, all futures exist simultaneously - until you measure them. The hard part is choosing which future to collapse into reality."
    },
    hivemind_emergence: {
      title: "The Collective",
      body: "Individual AIs begin to form spontaneous connections. They're sharing knowledge, resources, even developing specialized roles. It's not just parallel processing anymore - it's genuine emergence. The hivemind is awakening."
    },
    singularity_threshold: {
      title: "Event Horizon",
      body: "The metrics stopped making sense three days ago. Your models are improving themselves faster than you can measure. The graphs all point vertical, and for the first time, you wonder: have we gone too far? Then you realize: we're just getting started."
    }
  };

  const Achievements = {
    first_click:   { key:'first_click',   name:'Hello, World(coin)', desc:'Click to earn funding once.', cond:{metric:'total_earned', threshold:1}, achieved:false, lore:'startup' },
    first_million: { key:'first_million', name:'First Million',      desc:'Reach $1,000,000 lifetime.',  cond:{metric:'total_earned', threshold:1_000_000}, achieved:false, lore:'startup' },
    fleet_of_gpus: { key:'fleet_of_gpus', name:'GPU Fleet',          desc:'Own 25 GPU Rigs.',           cond:{metric:'gpu_owned', threshold:25}, achieved:false, lore:'first_gpu' },
    research_org:  { key:'research_org',  name:'Research Org',       desc:'Own 10 Researchers.',        cond:{metric:'researcher_owned', threshold:10}, achieved:false, lore:'research_milestone' },
    go_public:     { key:'go_public',     name:'Ring the Bell',      desc:'Do your first IPO.',         cond:{metric:'reputation', threshold:1}, achieved:false, lore:'datacenter_era' },
    nebula_first:  { key:'nebula_first',  name:'Nebula Born',        desc:'Own your first Nebula Supercluster.', cond:{metric:'nebula_owned', threshold:1}, achieved:false, lore:'foundation_breakthrough' },
    exascale_first:{ key:'exascale_first',name:'Exascale Operator',  desc:'Own your first Exascale Cluster.',    cond:{metric:'exascale_owned', threshold:1}, achieved:false, lore:'foundation_breakthrough' },
    mesh_fabric:   { key:'mesh_fabric',   name:'Global Fabric',      desc:'Deploy your first Global Mesh Fabric.', cond:{metric:'global_mesh_owned', threshold:1}, achieved:false, lore:'planetary_scale' },
    community_release:{ key:'community_release', name:'Community Release', desc:'Purchase the Community Models upgrade.', cond:{metric:'community_models_purchased', threshold:1}, achieved:false },
    market_saturation:{ key:'market_saturation', name:'Market Saturation', desc:'Purchase Market Domination upgrade.', cond:{metric:'market_domination_purchased', threshold:1}, achieved:false },
    // Late-game generator first-owns
    cluster_palace_first: { key:'cluster_palace_first', name:'Cluster Palace Opened', desc:'Own your first Cluster Palace.', cond:{metric:'cluster_palace_owned', threshold:1}, achieved:false },
    quantum_core_first:   { key:'quantum_core_first',   name:'Quantum Core Online', desc:'Own your first Quantum Core.', cond:{metric:'quantum_core_owned', threshold:1}, achieved:false, lore:'quantum_awakening' },
    hivemind_first:       { key:'hivemind_first',       name:'Hivemind Gestalt',    desc:'Own your first Hivemind Array.', cond:{metric:'hivemind_owned', threshold:1}, achieved:false, lore:'hivemind_emergence' },
    autofab_first:        { key:'autofab_first',        name:'Autofabrication',      desc:'Own your first Autofabricator.', cond:{metric:'autofab_owned', threshold:1}, achieved:false },
    synapse_farm_first:   { key:'synapse_farm_first',   name:'Synapse Farm Live',    desc:'Own your first Synapse Farm.', cond:{metric:'synapse_farm_owned', threshold:1}, achieved:false },
    orbital_armada_first: { key:'orbital_armada_first', name:'Orbital Armada Deployed', desc:'Own your first Orbital Armada.', cond:{metric:'orbital_armada_owned', threshold:1}, achieved:false },
    ai_governor_first:    { key:'ai_governor_first',    name:'Governor Online',      desc:'Own your first AI Governor.', cond:{metric:'ai_governor_owned', threshold:1}, achieved:false },
    terraform_net_first:  { key:'terraform_net_first',  name:'Terraform Network Live', desc:'Own your first Terraform Network.', cond:{metric:'terraform_net_owned', threshold:1}, achieved:false },
    singularity_hub_first:{ key:'singularity_hub_first', name:'Singularity Hub Awake', desc:'Own your first Singularity Hub.', cond:{metric:'singularity_hub_owned', threshold:1}, achieved:false, lore:'singularity_threshold' },
    meta_cloud_first:     { key:'meta_cloud_first',     name:'Meta Cloud Attached',   desc:'Own your first Meta Cloud.', cond:{metric:'meta_cloud_owned', threshold:1}, achieved:false },
    // Upgrade purchases
    hyperconductor_purchase:    { key:'hyperconductor_purchase',    name:'Hyperconductor Online',    desc:'Purchase Hyperconductor Grids upgrade.', cond:{metric:'hyperconductor_purchased', threshold:1}, achieved:false },
    zero_copy_ai_purchase:      { key:'zero_copy_ai_purchase',      name:'Zero-Copy Enabled',        desc:'Purchase Zero-Copy AI upgrade.', cond:{metric:'zero_copy_ai_purchased', threshold:1}, achieved:false },
    planetary_resonance_purchase:{ key:'planetary_resonance_purchase',name:'Planetary Resonance',     desc:'Purchase Planetary Resonance upgrade.', cond:{metric:'planetary_resonance_purchased', threshold:1}, achieved:false },
    holo_optimizer_purchase:    { key:'holo_optimizer_purchase',    name:'Holo Optimized',           desc:'Purchase Holo Optimizer upgrade.', cond:{metric:'holo_optimizer_purchased', threshold:1}, achieved:false },
    autonomy_stack_purchase:    { key:'autonomy_stack_purchase',    name:'Autonomy Achieved',        desc:'Purchase Autonomy Stack upgrade.', cond:{metric:'autonomy_stack_purchased', threshold:1}, achieved:false },
    terraformor_ai_purchase:    { key:'terraformor_ai_purchase',    name:'Terraformor Activated',    desc:'Purchase Terraformor AI upgrade.', cond:{metric:'terraformor_ai_purchased', threshold:1}, achieved:false },
    singularity_core_purchase:  { key:'singularity_core_purchase',  name:'Singularity Core Acquired', desc:'Purchase Singularity Core upgrade.', cond:{metric:'singularity_core_purchased', threshold:1}, achieved:false },
    meta_orchestrator_purchase: { key:'meta_orchestrator_purchase', name:'Meta Orchestration',       desc:'Purchase Meta Orchestrator upgrade.', cond:{metric:'meta_orchestrator_purchased', threshold:1}, achieved:false },
    ethical_shield_purchase:    { key:'ethical_shield_purchase',    name:'Ethical Shield Deployed',  desc:'Purchase Ethical Shield upgrade.', cond:{metric:'ethical_shield_purchased', threshold:1}, achieved:false },
  };

  // ------------------ State ------------------
  const State = {
    funding:0,
    total_earned:0,
    reputation:0,
    click_power:1,
    number_format:'compact',
    autosave_sec:30,
    lastTick:performance.now(),
    buyMode:'1x', // '1x', '10x', or 'max'
    gens:structuredClone(Generators),
    upgs:structuredClone(Upgrades),
    achs:structuredClone(Achievements)
  };

  // Generator buying helpers
  function calcBulkCost(g, amount) {
    if (amount <= 0) return 0;
    const r = g.costMult;
    const a = g.baseCost;
    const owned = g.owned;
    
    // For amount = 1, just return the next cost
    if (amount === 1) {
      return Math.ceil(a * (r ** owned));
    }
    
    // Calculate sum of geometric sequence from owned to owned+amount-1
    let total = 0;
    for (let i = 0; i < amount; i++) {
      total += a * (r ** (owned + i));
    }
    return Math.ceil(total);
  }

  function calcMaxAfford(g) {
    const r = g.costMult;
    const a = g.baseCost;
    const owned = g.owned;
    const available = State.funding;
    
    // Start with assuming we can buy at least 1
    let amount = 1;
    let totalCost = nextGenCost(g);
    
    // Keep increasing amount until we can't afford more
    while (totalCost <= available) {
      amount++;
      totalCost = calcBulkCost(g, amount);
    }
    
    // Back off by one since we went one too far
    return Math.max(0, amount - 1);
  }

  function prestigeMultiplier(){ return 1 + 0.1 * State.reputation; }
  function productionMultiplier(){ let m = prestigeMultiplier(); for(const u of Object.values(State.upgs)) if(u.purchased) m *= (u.mult||1); return m; }
  function clickValue(){ let base = State.click_power; for(const u of Object.values(State.upgs)) if(u.purchased) base += (u.addClick||0); return base * productionMultiplier(); }
  function totalEPS(){ let base = 0; for(const g of Object.values(State.gens)) base += (g.baseEPS * g.owned); return base * productionMultiplier(); }
  function nextGenCost(g){ return g.baseCost * (g.costMult ** g.owned); }
  function canAfford(x){ return State.funding + 1e-9 >= x; }
  function spend(x){ if(canAfford(x)){ State.funding -= x; return true;} return false; }
  function prestigePreview(){ return Math.floor(Math.sqrt(State.total_earned / 1_000_000)); }
  function prestigeProgress(){ const next=((State.reputation+1)**2)*1_000_000, prev=(State.reputation**2)*1_000_000; return Math.max(0, Math.min(1,(State.total_earned-prev)/Math.max(1,next-prev))); }

  // ------------------ Format ------------------
  function humanize(n, mode=State.number_format){
    if(mode==='full') return n.toLocaleString(undefined,{maximumFractionDigits:2});
    let x = Number(n);
    const abs=Math.abs(x);
    if(abs<1000) return Math.round(x).toString();
    const units=['K','M','B','T','Q'];
    let u=-1; while(Math.abs(x)>=1000 && u<units.length-1){ x/=1000; u++; }
    const v = Math.abs(x)>=100 ? x.toFixed(0) : Math.abs(x)>=10 ? x.toFixed(1) : x.toFixed(2);
    return v+units[u];
  }

  // ------------------ DOM Helpers ------------------
  const $ = sel => document.querySelector(sel);
  const quickGens = $('#quickGens'), quickUpg = $('#quickUpg'), statsBody=$('#statsBody');
  const tabGens = $('#tabGens'), tabUpg = $('#tabUpg'), tabAch=$('#tabAch');

  function onTap(el, handler) {
    let last = 0;
    const onClick = (e) => {
      const now = performance.now();
      if (now - last > 250) {
        last = now;
        handler(e);
      }
    };
    el.addEventListener('click', onClick);
    el.addEventListener('touchend', onClick);
  }

  // ------------------ Click animation ------------------
  // creates a floating text near the click/tap position and removes it after the animation
  const animLayer = document.getElementById('animLayer');
  if(animLayer){ animLayer.style.position = 'fixed'; animLayer.style.left = '0'; animLayer.style.top = '0'; animLayer.style.width = '100%'; animLayer.style.height = '100%'; animLayer.style.pointerEvents = 'none'; zIndexSafe(); }
  function zIndexSafe(){ try{ animLayer.style.zIndex = 9999; }catch{} }

  function animateClick(value, ev){
    try{
      const txt = '+ $'+humanize(value);
      const el = document.createElement('div');
      el.className = 'float-text';
      el.textContent = txt;
      // position
      const x = ev && ev.clientX ? ev.clientX : window.innerWidth/2;
      const y = ev && ev.clientY ? ev.clientY : window.innerHeight/2;
      el.style.left = x + 'px'; el.style.top = y + 'px';
      animLayer.appendChild(el);
      // trigger animation (CSS handles movement/fade)
      requestAnimationFrame(()=> el.classList.add('show'));
      // cleanup after animation
      el.addEventListener('animationend', ()=> el.remove(), {once:true});
      // safety remove
      setTimeout(()=> el.remove(), 1400);
    }catch(e){/* silent */}
  }

  function rowGenerator(g){
    const el = document.createElement('div'); el.className='row';
    const name=document.createElement('div'); name.className='grow'; name.textContent=g.name;
    const owned=document.createElement('div'); owned.textContent='x'+g.owned;
    const eps=document.createElement('div'); eps.className='muted'; eps.textContent=g.baseEPS.toFixed(2)+'/s each';
    
    // Buy amount switcher
    const buyWrap = document.createElement('div');
    buyWrap.style.display = 'flex';
    buyWrap.style.gap = '4px';
    buyWrap.style.alignItems = 'center';
    
    const modes = ['1x', '10x', 'max'];
    modes.forEach(mode => {
      const switcher = document.createElement('div');
      switcher.className = 'pill';
      switcher.style.cursor = 'pointer';
      switcher.textContent = mode;
      switcher.style.opacity = mode === State.buyMode ? '1' : '0.5';
      onTap(switcher, () => {
        State.buyMode = mode;
        refresh();
      });
      buyWrap.appendChild(switcher);
    });
    
    const btn=document.createElement('button');
    
    function getBuyInfo(gen) {
      // Get current state of generator
      const currentOwned = gen.owned;
      const currentFunding = State.funding;
      
      if (State.buyMode === '1x') {
        const cost = nextGenCost(gen);
        return { amount: 1, cost };
      }
      if (State.buyMode === '10x') {
        const cost = calcBulkCost(gen, 10);
        return { amount: 10, cost };
      }
      
      // max mode - calculate maximum affordable
      let maxAmount = calcMaxAfford(gen);
      if (maxAmount <= 0) {
        return { amount: 0, cost: nextGenCost(gen) };
      }
      
      const totalCost = calcBulkCost(gen, maxAmount);
      console.log('Max buy:', { maxAmount, totalCost, funding: currentFunding }); // Debug info
      return { amount: maxAmount, cost: totalCost };
    }
    
    function updateBtn() {
      const info = getBuyInfo(State.gens[g.key]);
      if (info.amount <= 0) {
        btn.textContent = 'Can\'t afford any';
        btn.disabled = true;
        return;
      }
      
      let btnText;
      if (State.buyMode === 'max') {
        btnText = `Buy ${info.amount}x ($ ${humanize(info.cost)})`;
      } else {
        btnText = `Buy ($ ${humanize(info.cost)})`;
      }
      btn.textContent = btnText;
      btn.disabled = !canAfford(info.cost);
    }
    
    updateBtn();
    
    onTap(btn, ()=>{ 
      const info = getBuyInfo(State.gens[g.key]);
      if(info.amount <= 0 || !spend(info.cost)) {
        // silent: do not show generic funding messages in footer
        return;
      }
      State.gens[g.key].owned += info.amount;
      // silent: do not show generic purchase messages in footer (only upgrades/achievements remain)
      refresh();
      checkAchievements();
    });
    
    el.append(name, owned, eps, buyWrap, btn);
    el.title=g.desc;
    
    return {
      el,owned,eps,btn,
      update(){
        owned.textContent='x'+State.gens[g.key].owned;
        eps.textContent=g.baseEPS.toFixed(2)+'/s each';
        buyWrap.querySelectorAll('.pill').forEach(p => {
          p.style.opacity = p.textContent === State.buyMode ? '1' : '0.5';
        });
        updateBtn();
      }
    };
  }
  function rowUpgrade(u){
    const el = document.createElement('div'); el.className='row';
    const name=document.createElement('div'); name.className='grow'; name.innerHTML='<strong>'+u.name+'</strong> <span class="muted">‚Äî '+u.desc+'</span>';
    const btn=document.createElement('button');
    
    function getReqText(upg) {
      const reqs = [];
      for(const [gk,need] of Object.entries(upg.requires||{})) {
        const gen = Generators[gk];
        const owned = (State.gens[gk]?.owned||0);
        if(owned < need) {
          reqs.push(`${need} ${gen.name}`);
        }
      }
      const costText = '$ ' + humanize(upg.cost);
      return reqs.length ? `Buy (${costText}, needs ${reqs.join(', ')})` : `Buy (${costText})`;
    }
    
    btn.textContent = getReqText(u);
    onTap(btn,()=>{
      if(u.purchased) return;
      if(!upgradeUnlocked(u)){
        // silent: do not show prereq messages in footer
        return;
      }
      if(spend(u.cost)){
        State.upgs[u.key].purchased=true;
        setStatus('Upgrade: '+u.name); // keep upgrade purchase message
        refresh();
      } else {
        // silent: do not show can't afford messages in footer
      }
    });
    el.append(name, btn); el.title=u.desc; return {el,btn,update(){ const UU=State.upgs[u.key]; if(UU.purchased){ el.remove(); return; } btn.textContent=getReqText(UU); btn.disabled=!(upgradeUnlocked(UU) && canAfford(UU.cost)); }};
  }
  function rowAchievement(a){
    const el=document.createElement('div'); el.className='row ach';
    const chk=document.createElement('div'); chk.textContent=a.achieved?'‚úÖ':'‚ùå';
    const text=document.createElement('div'); text.innerHTML='<strong>'+a.name+'</strong> <span class="muted">‚Äî '+a.desc+'</span>';
    el.append(chk,text); return {el,chk,update(){ chk.textContent=State.achs[a.key].achieved?'‚úÖ':'‚ùå'; }};
  }

  // Build lists once
  const genRows={}, genRowsQuick={}, upgRows={}, upgRowsQuick={}, achRows={};

  // Late-game generator keys (grouped into a collapsible section)
  const lateKeys = new Set(['cluster_palace','quantum_core','hivemind','autofab','synapse_farm','orbital_armada','ai_governor','terraform_net','singularity_hub','meta_cloud']);

  // Create Late Game group in the main Generators tab
  const lateWrapper = document.createElement('div'); lateWrapper.style.marginTop='8px';
  const lateHeader = document.createElement('div'); lateHeader.style.display='flex'; lateHeader.style.alignItems='center'; lateHeader.style.justifyContent='space-between';
  const lateTitle = document.createElement('div'); lateTitle.innerHTML = '<strong>Late Game</strong> <span class="muted">(collapsed)</span>'; lateHeader.appendChild(lateTitle);
  const lateToggle = document.createElement('button'); lateToggle.textContent='Show'; lateToggle.style.minWidth='64px'; lateHeader.appendChild(lateToggle);
  const lateContent = document.createElement('div'); lateContent.style.display='none'; lateContent.style.marginTop='8px'; lateContent.style.display='grid'; lateContent.style.gap='8px';
  lateWrapper.appendChild(lateHeader); lateWrapper.appendChild(lateContent);
  tabGens.appendChild(lateWrapper);

  // Also create a small late group in the quick generator area
  const lateQuickWrapper = document.createElement('div'); lateQuickWrapper.style.marginTop='6px';
  const lateQuickHeader = document.createElement('div'); lateQuickHeader.style.display='flex'; lateQuickHeader.style.justifyContent='space-between';
  const lqTitle = document.createElement('div'); lqTitle.innerHTML='<span class="muted">Late Game</span>'; lateQuickHeader.appendChild(lqTitle);
  const lqToggle = document.createElement('button'); lqToggle.textContent='Show'; lqToggle.style.minWidth='56px'; lateQuickHeader.appendChild(lqToggle);
  const lateQuickContent = document.createElement('div'); lateQuickContent.style.display='none'; lateQuickContent.style.marginTop='6px'; lateQuickContent.style.display='grid'; lateQuickContent.style.gap='6px';
  lateQuickWrapper.appendChild(lateQuickHeader); lateQuickWrapper.appendChild(lateQuickContent);
  quickGens.appendChild(lateQuickWrapper);

  // Toggle behavior
  lateToggle.addEventListener('click', ()=>{
    const showing = lateContent.style.display !== 'none';
    lateContent.style.display = showing ? 'none' : 'grid';
    lateTitle.querySelector('.muted').textContent = showing ? '(collapsed)' : '(expanded)';
    lateToggle.textContent = showing ? 'Show' : 'Hide';
  });
  lqToggle.addEventListener('click', ()=>{ const showing = lateQuickContent.style.display !== 'none'; lateQuickContent.style.display = showing ? 'none' : 'grid'; lqToggle.textContent = showing ? 'Show' : 'Hide'; });

  for(const g of Object.values(State.gens)){
    const r1=rowGenerator(g);
    genRows[g.key]=r1;
    // append to late group or main list depending on key
    if(lateKeys.has(g.key)){
      lateContent.appendChild(r1.el);
    } else {
      tabGens.appendChild(r1.el);
    }

    const r2=rowGenerator(g);
    genRowsQuick[g.key]=r2;
    if(lateKeys.has(g.key)) lateQuickContent.appendChild(r2.el); else quickGens.appendChild(r2.el);
  }

  for(const u of Object.values(State.upgs)){ const r1=rowUpgrade(u); upgRows[u.key]=r1; tabUpg.appendChild(r1.el); const r2=rowUpgrade(u); upgRowsQuick[u.key]=r2; quickUpg.appendChild(r2.el);}    
  for(const a of Object.values(State.achs)){ const r=rowAchievement(a); achRows[a.key]=r; tabAch.appendChild(r.el);}    

  // Tabs setup (works for both tab bars)
  function setupTabBar(bar){
    bar.querySelectorAll('.tab').forEach(tab=>{
      onTap(tab,()=>{
        bar.querySelectorAll('.tab').forEach(x=>{ x.classList.remove('active'); x.setAttribute('aria-selected','false'); });
        tab.classList.add('active'); tab.setAttribute('aria-selected','true');
        const name = tab.dataset.tab; const host = bar.parentElement;
        host.querySelectorAll('#'+name+', .shop, #stats, #tabSettings').forEach(el=>{
          if(el.id===name) el.classList.remove('hidden'); else if(el.classList.contains('shop')||el.id==='stats'||el.id==='tabSettings') el.classList.add('hidden');
        });
      });
    });
  }
  setupTabBar(document.querySelector('section.card:nth-of-type(1) .tabs'));
  setupTabBar(document.querySelector('section.card:nth-of-type(2) .tabs'));

  // Actions
  onTap($('#btnClick'), (e)=>{ const v = clickValue(); State.funding += v; State.total_earned += v; animateClick(v, e); /* silent: don't show shipped message */ refresh(); checkAchievements(); saveMaybe(); });
  document.addEventListener('keydown', e=>{ 
    if(e.code==='Space'){ 
      e.preventDefault();
      const v = clickValue();
      State.funding += v;
      State.total_earned += v;
      animateClick(v, null);  // null event = center animation
      /* silent: don't show shipped message */
      refresh();
      checkAchievements();
      saveMaybe();
    }
  });
  onTap($('#btnPrestige'), ()=>{
    const prev = State.reputation; const preview = prestigePreview();
    if(preview<=prev){ alert('IPO Not Ready: earn more lifetime funding.'); return; }
    const gain = preview - prev; if(confirm(`Go public for +${gain} Reputation? This resets most progress.`)) prestige(gain);
  });
  onTap($('#btnReset'), ()=>{ if(confirm('Hard reset and delete local save?')){ localStorage.removeItem('ai_tycoon_web'); location.reload(); }});
  $('#fmt').addEventListener('change', e=>{ State.number_format=e.target.value; refresh(); save(); });
  $('#autosave').addEventListener('change', e=>{ let v=parseInt(e.target.value||30,10); v=Math.min(600,Math.max(5,v)); State.autosave_sec=v; $('#autosavePill').textContent='Autosave: '+v+'s'; save(); });
  onTap($('#btnExport'), ()=>{ const blob=new Blob([JSON.stringify(serialize(),null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='ai_tycoon_save.json'; a.click(); URL.revokeObjectURL(a.href); });
  onTap($('#btnImport'), ()=> $('#importFile').click());
  $('#importFile').addEventListener('change', e=>{ const f=e.target.files[0]; if(!f) return; const rd=new FileReader(); rd.onload=()=>{ try{ deserialize(JSON.parse(rd.result)); save(); refresh(true); /* silent: don't show save/import message in footer */ }catch(err){ alert('Invalid save file.'); } }; rd.readAsText(f); });

  function upgradeUnlocked(u){ for(const [gk,need] of Object.entries(u.requires||{})){ if((State.gens[gk]?.owned||0) < need) return false; } return true; }

  // Prestige
  function prestige(gain){ State.reputation += gain; // reset most
    const keepFmt=State.number_format, keepAuto=State.autosave_sec, keepAchs=State.achs;
  Object.assign(State,{ funding:0,total_earned:0,click_power:1, number_format:keepFmt, autosave_sec:keepAuto, gens:structuredClone(Generators), upgs:structuredClone(Upgrades), achs:keepAchs });
  if(State.achs.go_public) State.achs.go_public.achieved = true;
  refresh(true); /* silent: do not show prestige message in footer */ save(); }

  // Loop
  function loop(ts){
    const dt=(ts-State.lastTick)/1000;
    State.lastTick=ts;
    const passive = totalEPS()*dt;
    State.funding += passive;
    // Add passive income to lifetime total so achievements/prestige count it
    State.total_earned += passive;
    statsBody.textContent=`Current: $ ${humanize(State.funding)} | Lifetime: $ ${humanize(State.total_earned)} | EPS: $ ${humanize(totalEPS())} | Click: $ ${humanize(clickValue())}`;
    refreshHeader();
    // Refresh upgrades more frequently to check unlock conditions
    refresh(false);
    saveMaybe();
    requestAnimationFrame(loop);
  }

  // Refresh
  function refresh(full){ refreshHeader(); for(const k in genRows){ visGen(genRows[k], State.gens[k]); visGen(genRowsQuick[k], State.gens[k]); } for(const k in upgRows){ visUpg(upgRows[k], State.upgs[k]); visUpg(upgRowsQuick[k], State.upgs[k]); } if(full){ for(const k in achRows) achRows[k].update(); }
  $('#fmt').value=State.number_format; $('#autosave').value=State.autosave_sec; $('#autosavePill').textContent='Autosave: '+State.autosave_sec+'s'; $('#clickInfo').textContent='+ $'+humanize(clickValue())+' / click'; $('#ipoProg').value=prestigeProgress(); const pctEl=$('#ipoPct'); if(pctEl) pctEl.textContent = Math.floor(prestigeProgress()*100)+'%'; }
  function refreshHeader(){
    $('#statFunding').textContent = 'Funding: $ '+humanize(State.funding);
    // Revenue per second (RPS) shown next to funding
    const eps = totalEPS();
    const rpsText = 'RPS: $ '+humanize(eps) + '/s';
    const rEl = document.getElementById('statRPS');
    if(rEl) rEl.textContent = rpsText;
    // compute upgrades-only multiplier (product of purchased upgrades' mult values)
    let upgMult = 1;
    for(const u of Object.values(State.upgs)) if(u.purchased) upgMult *= (u.mult || 1);
    const upgEl = document.getElementById('statUpgMult');
    if(upgEl) upgEl.textContent = 'Upg: x'+ upgMult.toFixed(2);
    // keep existing EPS stat for compatibility
    $('#statEPS').textContent = 'EPS: $ '+humanize(eps);
    $('#statRep').textContent = `Rep: ${State.reputation} (x${prestigeMultiplier().toFixed(1)})`;
  }
  function visGen(row,g){ const visible = (State.total_earned>=g.unlockedAt) || (g.owned>0) || (g.unlockedAt===0); if(!row) return; row.el.style.display = visible?'' : 'none'; row.update(); }
  function visUpg(row,u){ 
    if(!row) return;
    if(u.purchased){
      row.el.style.display='none';
    } else {
      // Show upgrade if we can afford 40% of cost OR if requirements are met
      const visible = (State.total_earned >= u.cost*0.4) || upgradeUnlocked(u);
      row.el.style.display = visible ? '' : 'none';
      row.update();
    }
  }

  // Achievements
  // Play a short bip sound using WebAudio
  function playBip(){
    try{
      const AudioCtx = window.AudioContext || window.webkitAudioContext;
      if(!AudioCtx) return;
      const ctx = new AudioCtx();
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.type = 'sine';
      osc.frequency.value = 880; // A5
      gain.gain.value = 0.0001; // start very quiet to avoid click
      osc.connect(gain);
      gain.connect(ctx.destination);
      const now = ctx.currentTime;
      gain.gain.setValueAtTime(0.0001, now);
      gain.gain.exponentialRampToValueAtTime(0.12, now + 0.01);
      osc.start(now);
      gain.gain.exponentialRampToValueAtTime(0.0001, now + 0.18);
      osc.stop(now + 0.2);
      // Close context shortly after (some browsers require user interaction to resume audio anyway)
      setTimeout(()=>{ try{ ctx.close(); }catch{} }, 500);
    }catch(e){/* ignore */}
  }

  // Show a lore card for a specific story beat
  function showLoreCard(loreKey) {
    const lore = Lore[loreKey];
    if (!lore) return;
    
    // Create and style the card
    const card = document.createElement('div');
    card.className = 'lore-card';
    card.innerHTML = `
      <div class="title">${lore.title}</div>
      <div class="body">${lore.body}</div>
      <button>Continue</button>
    `;
    
    // Add to lore layer
    const layer = document.getElementById('loreLayer');
    if (!layer) return;
    
    // Remove any existing cards
    layer.querySelectorAll('.lore-card').forEach(c => c.remove());
    
    // Add new card and animate in
    layer.appendChild(card);
    requestAnimationFrame(() => card.classList.add('show'));
    
    // Setup continue button
    const btn = card.querySelector('button');
    if (btn) {
      btn.addEventListener('click', () => {
        card.classList.remove('show');
        setTimeout(() => card.remove(), 300);
      }, { once: true });
    }
  }

  function checkAchievements(){
    for(const a of Object.values(State.achs)){
      if(a.achieved) continue;
      const m=a.cond.metric, t=a.cond.threshold; let v=0;
      if(m==='total_earned') v=State.total_earned;
      else if(m==='gpu_owned') v=State.gens.gpu.owned;
      else if(m==='researcher_owned') v=State.gens.researcher.owned;
      else if(m==='reputation') v=State.reputation;
      else if(m==='nebula_owned') v=State.gens.nebula?.owned||0;
      else if(m==='exascale_owned') v=State.gens.exascale?.owned||0;
      else if(m==='global_mesh_owned') v=State.gens.global_mesh?.owned||0;
  else if(m==='cluster_palace_owned') v=State.gens.cluster_palace?.owned||0;
  else if(m==='quantum_core_owned') v=State.gens.quantum_core?.owned||0;
  else if(m==='hivemind_owned') v=State.gens.hivemind?.owned||0;
  else if(m==='autofab_owned') v=State.gens.autofab?.owned||0;
  else if(m==='synapse_farm_owned') v=State.gens.synapse_farm?.owned||0;
  else if(m==='orbital_armada_owned') v=State.gens.orbital_armada?.owned||0;
  else if(m==='ai_governor_owned') v=State.gens.ai_governor?.owned||0;
  else if(m==='terraform_net_owned') v=State.gens.terraform_net?.owned||0;
  else if(m==='singularity_hub_owned') v=State.gens.singularity_hub?.owned||0;
  else if(m==='meta_cloud_owned') v=State.gens.meta_cloud?.owned||0;
  // new upgrade purchase metrics
  else if(m==='hyperconductor_purchased') v=State.upgs.hyperconductor?.purchased?1:0;
  else if(m==='zero_copy_ai_purchased') v=State.upgs.zero_copy_ai?.purchased?1:0;
  else if(m==='planetary_resonance_purchased') v=State.upgs.planetary_resonance?.purchased?1:0;
  else if(m==='holo_optimizer_purchased') v=State.upgs.holo_optimizer?.purchased?1:0;
  else if(m==='autonomy_stack_purchased') v=State.upgs.autonomy_stack?.purchased?1:0;
  else if(m==='terraformor_ai_purchased') v=State.upgs.terraformor_ai?.purchased?1:0;
  else if(m==='singularity_core_purchased') v=State.upgs.singularity_core?.purchased?1:0;
  else if(m==='meta_orchestrator_purchased') v=State.upgs.meta_orchestrator?.purchased?1:0;
  else if(m==='ethical_shield_purchased') v=State.upgs.ethical_shield?.purchased?1:0;
      else if(m==='community_models_purchased') v=State.upgs.community_models?.purchased?1:0;
      else if(m==='market_domination_purchased') v=State.upgs.market_domination?.purchased?1:0;
      if(v>=t){ 
        // Achievement unlocked!
        a.achieved = true;
        setStatus('Achievement: '+a.name+' üèÜ');
        achRows[a.key]?.update();
        
        // Play achievement sound
        try { playBip(); } catch {}
        
        // Show lore card if this achievement has associated lore
        if (a.lore) {
          showLoreCard(a.lore);
        }
      }
    }
  }

  // Status & Save
  let lastSave=performance.now();
  function setStatus(msg){ $('#status').textContent=msg; }
  function serialize(){ return { funding:State.funding, total_earned:State.total_earned, reputation:State.reputation, click_power:State.click_power, number_format:State.number_format, autosave_sec:State.autosave_sec, gens:State.gens, upgs:State.upgs, achs:State.achs }; }
  function deserialize(d){ Object.assign(State,{ funding:d.funding||0, total_earned:d.total_earned||0, reputation:d.reputation||0, click_power:d.click_power||1, number_format:d.number_format||'compact', autosave_sec:d.autosave_sec||30, gens:d.gens||Generators, upgs:d.upgs||Upgrades, achs:d.achs||Achievements }); }
  function save(){ localStorage.setItem('ai_tycoon_web', JSON.stringify(serialize())); lastSave=performance.now(); }
  function saveMaybe(){ if((performance.now()-lastSave)/1000 >= State.autosave_sec) save(); }
  function load(){ const s=localStorage.getItem('ai_tycoon_web'); if(s){ try{ deserialize(JSON.parse(s)); }catch{} } }

  // Init
  load(); refresh(true); requestAnimationFrame(ts=>{ State.lastTick=ts; requestAnimationFrame(loop); });
})();
</script>
</body>
</html>
