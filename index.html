<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>AI Tycoon ‚Äî Incremental Clicker (Web)</title>
<style>
  :root{
    --bg:#0f141b; --fg:#e8eef6; --panel:#1a212b; --panel2:#141a22; --acc:#2b3442; --ok:#4ad295; --warn:#f6c85f; --bad:#ef6f6c;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;touch-action:manipulation}
  header{display:flex;flex-wrap:wrap;gap:12px 16px;align-items:center;padding:clamp(10px,1.8vh,16px) max(12px,env(safe-area-inset-left)) max(10px,env(safe-area-inset-right));background:linear-gradient(180deg,var(--panel),var(--panel2));border-bottom:1px solid #0008;position:sticky;top:0;z-index:10}
  header h1{font-size:clamp(16px,2.6vw,18px);margin:0;white-space:nowrap}
  .stat{margin-right:8px;white-space:nowrap;font-size:clamp(12px,2.4vw,15px)}
  .stat.hide-xs{display:none}
  .ipo{margin-left:auto;display:flex;align-items:center;gap:8px;min-width:220px}
  .ipo label{font-size:12px;opacity:.8}
  progress{accent-color:var(--ok);height:10px;width:min(44vw,280px)}

  main{display:grid;grid-template-columns: 1.1fr 1fr; gap:16px; padding:16px;}
  .card{background:var(--panel); border:1px solid #0008; border-radius:14px; padding:12px;}
  .title{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
  button{background:#2c3950;border:1px solid #000; color:var(--fg); padding:12px 14px; border-radius:12px; cursor:pointer; min-height:44px}
  button:disabled{opacity:.5;cursor:not-allowed}
  .shop{display:flex;flex-direction:column;gap:8px;max-height:48vh;overflow:auto;padding-right:4px}
  .row{display:flex;align-items:center;gap:8px;padding:10px;border-radius:12px;background:var(--panel2);border:1px solid #0006}
  .row .grow{flex:1;min-width:160px}
  .row .muted{opacity:.7}
  .tabs{display:flex;gap:6px;margin:8px 0 10px;flex-wrap:wrap}
  .tab{padding:8px 10px;border-radius:10px;background:var(--panel2);border:1px solid #0006;cursor:pointer;user-select:none}
  .tab.active{outline:2px solid #3d4f6b}
  .hidden{display:none}
  footer{position:sticky;bottom:0;background:linear-gradient(0deg,var(--panel),var(--panel2));border-top:1px solid #0008;padding:8px 12px calc(8px + env(safe-area-inset-bottom));color:#c9d4e5;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .pill{padding:4px 10px;border-radius:999px;background:#223041;border:1px solid #0006;font-size:13px}
  a{color:#9ecbff}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .ach{display:flex;gap:8px;align-items:center}
</style>
</head>
<body>
  <header>
    <h1>üß† AI Tycoon ‚Äî Web</h1>
    <div class="stat" id="statFunding">Funding: $0</div>
  <div class="stat" id="statRPS">RPS: $0/s</div>
    <div class="stat hide-xs" id="statEPS">EPS: $0/s</div>
    <div class="stat" id="statRep">Rep: 0 (x1.0)</div>
    <div class="ipo">
      <label for="ipoProg">IPO</label>
      <progress id="ipoProg" max="1" value="0"></progress>
      <button id="btnPrestige" aria-label="Go Public">Go Public</button>
    </div>
  </header>

  <main class="grid2">
    <section class="card">
      <div class="title"><strong>Play</strong><span id="clickInfo" class="pill">+ $1 / click</span></div>
      <button id="btnClick" style="width:100%;font-size:20px">üöÄ Ship Feature</button>
      <div class="tabs" role="tablist" aria-label="Play Tabs">
        <div class="tab active" data-tab="quickGens" role="tab" aria-selected="true">Quick Generators</div>
        <div class="tab" data-tab="quickUpg" role="tab" aria-selected="false">Quick Upgrades</div>
        <div class="tab" data-tab="stats" role="tab" aria-selected="false">Stats</div>
      </div>
      <div id="quickGens" class="shop" role="region" aria-label="Quick Generators"></div>
      <div id="quickUpg" class="shop hidden" role="region" aria-label="Quick Upgrades"></div>
      <div id="stats" class="hidden" role="region" aria-label="Stats">
        <p id="statsBody" style="margin:8px 0 0"></p>
      </div>
    </section>

    <section class="card">
      <div class="title"><strong>Management</strong></div>
      <div class="tabs" role="tablist" aria-label="Management Tabs">
        <div class="tab active" data-tab="tabGens" role="tab" aria-selected="true">Generators</div>
        <div class="tab" data-tab="tabUpg" role="tab" aria-selected="false">Upgrades</div>
        <div class="tab" data-tab="tabAch" role="tab" aria-selected="false">Achievements</div>
        <div class="tab" data-tab="tabSettings" role="tab" aria-selected="false">Settings</div>
      </div>
      <div id="tabGens" class="shop" role="region" aria-label="Generators"></div>
      <div id="tabUpg" class="shop hidden" role="region" aria-label="Upgrades"></div>
      <div id="tabAch" class="shop hidden" role="region" aria-label="Achievements"></div>
      <div id="tabSettings" class="hidden" role="region" aria-label="Settings">
        <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:8px 0">
          <label for="fmt">Number format:</label>
          <select id="fmt">
            <option value="compact">Compact</option>
            <option value="full">Full</option>
          </select>
          <label for="autosave" style="margin-left:12px">Autosave (s):</label>
          <input type="number" id="autosave" min="5" max="600" value="30" style="width:90px">
          <button id="btnExport">Export Save</button>
          <input type="file" id="importFile" accept="application/json" style="display:none"/>
          <button id="btnImport">Import Save</button>
          <button id="btnReset" style="margin-left:auto;background:#4a1010">Hard Reset</button>
        </div>
      </div>
    </section>
  </main>

  <footer>
    <span id="status">Welcome to AI Tycoon Web. Tap the rocket to ship features.</span>
    <span class="pill" id="autosavePill">Autosave: 30s</span>
  </footer>

  <!-- Animation layer for click effects -->
  <div id="animLayer" aria-hidden="true"></div>

<script>
(function(){
  // ------------------ Content ------------------
  const Generators = {
    intern:      { key:'intern',      name:'Intern Developer',    baseCost:15,     costMult:1.15, baseEPS:0.1,  owned:0, unlockedAt:0,     desc:'Sometimes compiles.' },
    gpu:         { key:'gpu',         name:'GPU Rig',             baseCost:100,    costMult:1.15, baseEPS:1.0,  owned:0, unlockedAt:50,    desc:'Gaming GPUs moonlighting.' },
    researcher:  { key:'researcher',  name:'Research Scientist',   baseCost:650,    costMult:1.17, baseEPS:7.5,  owned:0, unlockedAt:300,   desc:'SOTA trick, viral arXiv.' },
    datacenter:  { key:'datacenter',  name:'Mini Datacenter',      baseCost:4200,   costMult:1.18, baseEPS:45,   owned:0, unlockedAt:2000,  desc:'A few racks, lots of heat.' },
    foundation:  { key:'foundation',  name:'Foundation Model Team',baseCost:35000,  costMult:1.20, baseEPS:320,  owned:0, unlockedAt:20000, desc:'Mind‚Äëblowing demos.' },
    planetary:   { key:'planetary',   name:'Planet‚ÄëScale Inference',baseCost:250000, costMult:1.22, baseEPS:2400, owned:0, unlockedAt:150000,desc:'Edge accelerators everywhere.' },
    nebula:      { key:'nebula',      name:'Nebula Supercluster',  baseCost:2000000, costMult:1.25, baseEPS:18000, owned:0, unlockedAt:1000000, desc:'Massive clustered inference.' },
    exascale:    { key:'exascale',    name:'Exascale Cluster',     baseCost:12000000, costMult:1.27, baseEPS:120000, owned:0, unlockedAt:5000000, desc:'Exascale-level throughput.' },
    global_mesh: { key:'global_mesh', name:'Global Mesh Fabric',   baseCost:80000000, costMult:1.30, baseEPS:800000, owned:0, unlockedAt:50000000, desc:'Planetary-wide inference fabric.' },
  };

  const Upgrades = {
    click_hype:   { key:'click_hype',   name:'Launch Hype Site',       cost:50,     desc:'+2 click power.',           mult:1.0, addClick:2, requires:{} , purchased:false },
    global_brand: { key:'global_brand', name:'Global Brand Deal',      cost:1000,   desc:'x1.5 production.',           mult:1.5, addClick:0, requires:{intern:10}, purchased:false },
    tensor_cores: { key:'tensor_cores', name:'Tensor Cores Everywhere',cost:4000,   desc:'x1.8 production.',           mult:1.8, addClick:0, requires:{gpu:10}, purchased:false },
    paper_rec:    { key:'paper_rec',    name:'SOTA Paper + Recsys',    cost:20000,  desc:'x2.2 production.',           mult:2.2, addClick:0, requires:{researcher:10}, purchased:false },
    moe_scaling:  { key:'moe_scaling',  name:'MoE Scaling Laws',       cost:120000, desc:'x2.5 production.',           mult:2.5, addClick:0, requires:{foundation:5}, purchased:false },
    community_models: { key:'community_models', name:'Community Models',    cost:500000,  desc:'x1.4 production (open ecosystem).', mult:1.4, addClick:0, requires:{foundation:10}, purchased:false },
    ops_automation:   { key:'ops_automation',   name:'Ops Automation',      cost:2000000, desc:'x1.6 production (automation).', mult:1.6, addClick:0, requires:{datacenter:10}, purchased:false },
    federated_clients: { key:'federated_clients', name:'Federated Clients',  cost:10000000, desc:'x1.8 production (edge aggregation).', mult:1.8, addClick:0, requires:{planetary:10}, purchased:false },
    auto_synthesis:   { key:'auto_synthesis',   name:'Auto Synthesis',      cost:50000000, desc:'x2.0 production (auto‚Äëengineering).', mult:2.0, addClick:0, requires:{nebula:5}, purchased:false },
    market_domination: { key:'market_domination', name:'Market Domination',   cost:250000000, desc:'x3.0 production (global reach).', mult:3.0, addClick:0, requires:{global_mesh:2}, purchased:false },
  };

  const Achievements = {
    first_click:   { key:'first_click',   name:'Hello, World(coin)', desc:'Click to earn funding once.', cond:{metric:'total_earned', threshold:1}, achieved:false },
    first_million: { key:'first_million', name:'First Million',      desc:'Reach $1,000,000 lifetime.',  cond:{metric:'total_earned', threshold:1_000_000}, achieved:false },
    fleet_of_gpus: { key:'fleet_of_gpus', name:'GPU Fleet',          desc:'Own 25 GPU Rigs.',           cond:{metric:'gpu_owned', threshold:25}, achieved:false },
    research_org:  { key:'research_org',  name:'Research Org',       desc:'Own 10 Researchers.',        cond:{metric:'researcher_owned', threshold:10}, achieved:false },
    go_public:     { key:'go_public',     name:'Ring the Bell',      desc:'Do your first IPO.',         cond:{metric:'reputation', threshold:1}, achieved:false },
    nebula_first:  { key:'nebula_first',  name:'Nebula Born',        desc:'Own your first Nebula Supercluster.', cond:{metric:'nebula_owned', threshold:1}, achieved:false },
    exascale_first:{ key:'exascale_first',name:'Exascale Operator',  desc:'Own your first Exascale Cluster.',    cond:{metric:'exascale_owned', threshold:1}, achieved:false },
    mesh_fabric:   { key:'mesh_fabric',   name:'Global Fabric',      desc:'Deploy your first Global Mesh Fabric.', cond:{metric:'global_mesh_owned', threshold:1}, achieved:false },
    community_release:{ key:'community_release', name:'Community Release', desc:'Purchase the Community Models upgrade.', cond:{metric:'community_models_purchased', threshold:1}, achieved:false },
    market_saturation:{ key:'market_saturation', name:'Market Saturation', desc:'Purchase Market Domination upgrade.', cond:{metric:'market_domination_purchased', threshold:1}, achieved:false },
  };

  // ------------------ State ------------------
  const State = {
    funding:0,
    total_earned:0,
    reputation:0,
    click_power:1,
    number_format:'compact',
    autosave_sec:30,
    lastTick:performance.now(),
    buyMode:'1x', // '1x', '10x', or 'max'
    gens:structuredClone(Generators),
    upgs:structuredClone(Upgrades),
    achs:structuredClone(Achievements)
  };

  // Generator buying helpers
  function calcBulkCost(g, amount) {
    if (amount <= 0) return 0;
    const r = g.costMult;
    const a = g.baseCost;
    const owned = g.owned;
    
    // For amount = 1, just return the next cost
    if (amount === 1) {
      return Math.ceil(a * (r ** owned));
    }
    
    // Calculate sum of geometric sequence from owned to owned+amount-1
    let total = 0;
    for (let i = 0; i < amount; i++) {
      total += a * (r ** (owned + i));
    }
    return Math.ceil(total);
  }

  function calcMaxAfford(g) {
    const r = g.costMult;
    const a = g.baseCost;
    const owned = g.owned;
    const available = State.funding;
    
    // Start with assuming we can buy at least 1
    let amount = 1;
    let totalCost = nextGenCost(g);
    
    // Keep increasing amount until we can't afford more
    while (totalCost <= available) {
      amount++;
      totalCost = calcBulkCost(g, amount);
    }
    
    // Back off by one since we went one too far
    return Math.max(0, amount - 1);
  }

  function prestigeMultiplier(){ return 1 + 0.1 * State.reputation; }
  function productionMultiplier(){ let m = prestigeMultiplier(); for(const u of Object.values(State.upgs)) if(u.purchased) m *= (u.mult||1); return m; }
  function clickValue(){ let base = State.click_power; for(const u of Object.values(State.upgs)) if(u.purchased) base += (u.addClick||0); return base * productionMultiplier(); }
  function totalEPS(){ let base = 0; for(const g of Object.values(State.gens)) base += (g.baseEPS * g.owned); return base * productionMultiplier(); }
  function nextGenCost(g){ return g.baseCost * (g.costMult ** g.owned); }
  function canAfford(x){ return State.funding + 1e-9 >= x; }
  function spend(x){ if(canAfford(x)){ State.funding -= x; return true;} return false; }
  function prestigePreview(){ return Math.floor(Math.sqrt(State.total_earned / 1_000_000)); }
  function prestigeProgress(){ const next=((State.reputation+1)**2)*1_000_000, prev=(State.reputation**2)*1_000_000; return Math.max(0, Math.min(1,(State.total_earned-prev)/Math.max(1,next-prev))); }

  // ------------------ Format ------------------
  function humanize(n, mode=State.number_format){
    if(mode==='full') return n.toLocaleString(undefined,{maximumFractionDigits:2});
    let x = Number(n);
    const abs=Math.abs(x);
    if(abs<1000) return Math.round(x).toString();
    const units=['K','M','B','T','Q'];
    let u=-1; while(Math.abs(x)>=1000 && u<units.length-1){ x/=1000; u++; }
    const v = Math.abs(x)>=100 ? x.toFixed(0) : Math.abs(x)>=10 ? x.toFixed(1) : x.toFixed(2);
    return v+units[u];
  }

  // ------------------ DOM Helpers ------------------
  const $ = sel => document.querySelector(sel);
  const quickGens = $('#quickGens'), quickUpg = $('#quickUpg'), statsBody=$('#statsBody');
  const tabGens = $('#tabGens'), tabUpg = $('#tabUpg'), tabAch=$('#tabAch');

  function onTap(el, handler) {
    let last = 0;
    const onClick = (e) => {
      const now = performance.now();
      if (now - last > 250) {
        last = now;
        handler(e);
      }
    };
    el.addEventListener('click', onClick);
    el.addEventListener('touchend', onClick);
  }

  // ------------------ Click animation ------------------
  // creates a floating text near the click/tap position and removes it after the animation
  const animLayer = document.getElementById('animLayer');
  if(animLayer){ animLayer.style.position = 'fixed'; animLayer.style.left = '0'; animLayer.style.top = '0'; animLayer.style.width = '100%'; animLayer.style.height = '100%'; animLayer.style.pointerEvents = 'none'; zIndexSafe(); }
  function zIndexSafe(){ try{ animLayer.style.zIndex = 9999; }catch{} }

  function animateClick(value, ev){
    try{
      const txt = '+ $'+humanize(value);
      const el = document.createElement('div');
      el.className = 'float-text';
      el.textContent = txt;
      // position
      const x = ev && ev.clientX ? ev.clientX : window.innerWidth/2;
      const y = ev && ev.clientY ? ev.clientY : window.innerHeight/2;
      el.style.left = x + 'px'; el.style.top = y + 'px';
      animLayer.appendChild(el);
      // trigger animation (CSS handles movement/fade)
      requestAnimationFrame(()=> el.classList.add('show'));
      // cleanup after animation
      el.addEventListener('animationend', ()=> el.remove(), {once:true});
      // safety remove
      setTimeout(()=> el.remove(), 1400);
    }catch(e){/* silent */}
  }

  function rowGenerator(g){
    const el = document.createElement('div'); el.className='row';
    const name=document.createElement('div'); name.className='grow'; name.textContent=g.name;
    const owned=document.createElement('div'); owned.textContent='x'+g.owned;
    const eps=document.createElement('div'); eps.className='muted'; eps.textContent=g.baseEPS.toFixed(2)+'/s each';
    
    // Buy amount switcher
    const buyWrap = document.createElement('div');
    buyWrap.style.display = 'flex';
    buyWrap.style.gap = '4px';
    buyWrap.style.alignItems = 'center';
    
    const modes = ['1x', '10x', 'max'];
    modes.forEach(mode => {
      const switcher = document.createElement('div');
      switcher.className = 'pill';
      switcher.style.cursor = 'pointer';
      switcher.textContent = mode;
      switcher.style.opacity = mode === State.buyMode ? '1' : '0.5';
      onTap(switcher, () => {
        State.buyMode = mode;
        refresh();
      });
      buyWrap.appendChild(switcher);
    });
    
    const btn=document.createElement('button');
    
    function getBuyInfo(gen) {
      // Get current state of generator
      const currentOwned = gen.owned;
      const currentFunding = State.funding;
      
      if (State.buyMode === '1x') {
        const cost = nextGenCost(gen);
        return { amount: 1, cost };
      }
      if (State.buyMode === '10x') {
        const cost = calcBulkCost(gen, 10);
        return { amount: 10, cost };
      }
      
      // max mode - calculate maximum affordable
      let maxAmount = calcMaxAfford(gen);
      if (maxAmount <= 0) {
        return { amount: 0, cost: nextGenCost(gen) };
      }
      
      const totalCost = calcBulkCost(gen, maxAmount);
      console.log('Max buy:', { maxAmount, totalCost, funding: currentFunding }); // Debug info
      return { amount: maxAmount, cost: totalCost };
    }
    
    function updateBtn() {
      const info = getBuyInfo(State.gens[g.key]);
      if (info.amount <= 0) {
        btn.textContent = 'Can\'t afford any';
        btn.disabled = true;
        return;
      }
      
      let btnText;
      if (State.buyMode === 'max') {
        btnText = `Buy ${info.amount}x ($ ${humanize(info.cost)})`;
      } else {
        btnText = `Buy ($ ${humanize(info.cost)})`;
      }
      btn.textContent = btnText;
      btn.disabled = !canAfford(info.cost);
    }
    
    updateBtn();
    
    onTap(btn, ()=>{ 
      const info = getBuyInfo(State.gens[g.key]);
      if(info.amount <= 0 || !spend(info.cost)) {
        setStatus('Not enough funding.');
        return;
      }
      State.gens[g.key].owned += info.amount;
      setStatus(`Bought ${info.amount}x ${g.name}`);
      refresh();
      checkAchievements();
    });
    
    el.append(name, owned, eps, buyWrap, btn);
    el.title=g.desc;
    
    return {
      el,owned,eps,btn,
      update(){
        owned.textContent='x'+State.gens[g.key].owned;
        eps.textContent=g.baseEPS.toFixed(2)+'/s each';
        buyWrap.querySelectorAll('.pill').forEach(p => {
          p.style.opacity = p.textContent === State.buyMode ? '1' : '0.5';
        });
        updateBtn();
      }
    };
  }
  function rowUpgrade(u){
    const el = document.createElement('div'); el.className='row';
    const name=document.createElement('div'); name.className='grow'; name.innerHTML='<strong>'+u.name+'</strong> <span class="muted">‚Äî '+u.desc+'</span>';
    const btn=document.createElement('button');
    
    function getReqText(upg) {
      const reqs = [];
      for(const [gk,need] of Object.entries(upg.requires||{})) {
        const gen = Generators[gk];
        const owned = (State.gens[gk]?.owned||0);
        if(owned < need) {
          reqs.push(`${need} ${gen.name}`);
        }
      }
      const costText = '$ ' + humanize(upg.cost);
      return reqs.length ? `Buy (${costText}, needs ${reqs.join(', ')})` : `Buy (${costText})`;
    }
    
    btn.textContent = getReqText(u);
    onTap(btn,()=>{ if(u.purchased) return; if(!upgradeUnlocked(u)){ setStatus('Prerequisites not met.'); return; } if(spend(u.cost)){ State.upgs[u.key].purchased=true; setStatus('Upgrade: '+u.name); refresh(); } else setStatus("Can't afford."); });
    el.append(name, btn); el.title=u.desc; return {el,btn,update(){ const UU=State.upgs[u.key]; if(UU.purchased){ el.remove(); return; } btn.textContent=getReqText(UU); btn.disabled=!(upgradeUnlocked(UU) && canAfford(UU.cost)); }};
  }
  function rowAchievement(a){
    const el=document.createElement('div'); el.className='row ach';
    const chk=document.createElement('div'); chk.textContent=a.achieved?'‚úÖ':'‚ùå';
    const text=document.createElement('div'); text.innerHTML='<strong>'+a.name+'</strong> <span class="muted">‚Äî '+a.desc+'</span>';
    el.append(chk,text); return {el,chk,update(){ chk.textContent=State.achs[a.key].achieved?'‚úÖ':'‚ùå'; }};
  }

  // Build lists once
  const genRows={}, genRowsQuick={}, upgRows={}, upgRowsQuick={}, achRows={};
  for(const g of Object.values(State.gens)){ const r1=rowGenerator(g); genRows[g.key]=r1; tabGens.appendChild(r1.el); const r2=rowGenerator(g); genRowsQuick[g.key]=r2; quickGens.appendChild(r2.el);}    
  for(const u of Object.values(State.upgs)){ const r1=rowUpgrade(u); upgRows[u.key]=r1; tabUpg.appendChild(r1.el); const r2=rowUpgrade(u); upgRowsQuick[u.key]=r2; quickUpg.appendChild(r2.el);}    
  for(const a of Object.values(State.achs)){ const r=rowAchievement(a); achRows[a.key]=r; tabAch.appendChild(r.el);}    

  // Tabs setup (works for both tab bars)
  function setupTabBar(bar){
    bar.querySelectorAll('.tab').forEach(tab=>{
      onTap(tab,()=>{
        bar.querySelectorAll('.tab').forEach(x=>{ x.classList.remove('active'); x.setAttribute('aria-selected','false'); });
        tab.classList.add('active'); tab.setAttribute('aria-selected','true');
        const name = tab.dataset.tab; const host = bar.parentElement;
        host.querySelectorAll('#'+name+', .shop, #stats, #tabSettings').forEach(el=>{
          if(el.id===name) el.classList.remove('hidden'); else if(el.classList.contains('shop')||el.id==='stats'||el.id==='tabSettings') el.classList.add('hidden');
        });
      });
    });
  }
  setupTabBar(document.querySelector('section.card:nth-of-type(1) .tabs'));
  setupTabBar(document.querySelector('section.card:nth-of-type(2) .tabs'));

  // Actions
  onTap($('#btnClick'), (e)=>{ const v = clickValue(); State.funding += v; State.total_earned += v; animateClick(v, e); setStatus('Shipped a feature ‚ú®'); refresh(); checkAchievements(); saveMaybe(); });
  document.addEventListener('keydown', e=>{ 
    if(e.code==='Space'){ 
      e.preventDefault();
      const v = clickValue();
      State.funding += v;
      State.total_earned += v;
      animateClick(v, null);  // null event = center animation
      setStatus('Shipped a feature ‚ú®');
      refresh();
      checkAchievements();
      saveMaybe();
    }
  });
  onTap($('#btnPrestige'), ()=>{
    const prev = State.reputation; const preview = prestigePreview();
    if(preview<=prev){ alert('IPO Not Ready: earn more lifetime funding.'); return; }
    const gain = preview - prev; if(confirm(`Go public for +${gain} Reputation? This resets most progress.`)) prestige(gain);
  });
  onTap($('#btnReset'), ()=>{ if(confirm('Hard reset and delete local save?')){ localStorage.removeItem('ai_tycoon_web'); location.reload(); }});
  $('#fmt').addEventListener('change', e=>{ State.number_format=e.target.value; refresh(); save(); });
  $('#autosave').addEventListener('change', e=>{ let v=parseInt(e.target.value||30,10); v=Math.min(600,Math.max(5,v)); State.autosave_sec=v; $('#autosavePill').textContent='Autosave: '+v+'s'; save(); });
  onTap($('#btnExport'), ()=>{ const blob=new Blob([JSON.stringify(serialize(),null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='ai_tycoon_save.json'; a.click(); URL.revokeObjectURL(a.href); });
  onTap($('#btnImport'), ()=> $('#importFile').click());
  $('#importFile').addEventListener('change', e=>{ const f=e.target.files[0]; if(!f) return; const rd=new FileReader(); rd.onload=()=>{ try{ deserialize(JSON.parse(rd.result)); save(); refresh(true); setStatus('Save imported.'); }catch(err){ alert('Invalid save file.'); } }; rd.readAsText(f); });

  function upgradeUnlocked(u){ for(const [gk,need] of Object.entries(u.requires||{})){ if((State.gens[gk]?.owned||0) < need) return false; } return true; }

  // Prestige
  function prestige(gain){ State.reputation += gain; // reset most
    const keepFmt=State.number_format, keepAuto=State.autosave_sec, keepAchs=State.achs;
    Object.assign(State,{ funding:0,total_earned:0,click_power:1, number_format:keepFmt, autosave_sec:keepAuto, gens:structuredClone(Generators), upgs:structuredClone(Upgrades), achs:keepAchs });
    if(State.achs.go_public) State.achs.go_public.achieved = true;
    refresh(true); setStatus('IPO complete. +'+gain+' Reputation'); save(); }

  // Loop
  function loop(ts){
    const dt=(ts-State.lastTick)/1000;
    State.lastTick=ts;
    const passive = totalEPS()*dt;
    State.funding += passive;
    // Add passive income to lifetime total so achievements/prestige count it
    State.total_earned += passive;
    statsBody.textContent=`Current: $ ${humanize(State.funding)} | Lifetime: $ ${humanize(State.total_earned)} | EPS: $ ${humanize(totalEPS())} | Click: $ ${humanize(clickValue())}`;
    refreshHeader();
    // Refresh upgrades more frequently to check unlock conditions
    refresh(false);
    saveMaybe();
    requestAnimationFrame(loop);
  }

  // Refresh
  function refresh(full){ refreshHeader(); for(const k in genRows){ visGen(genRows[k], State.gens[k]); visGen(genRowsQuick[k], State.gens[k]); } for(const k in upgRows){ visUpg(upgRows[k], State.upgs[k]); visUpg(upgRowsQuick[k], State.upgs[k]); } if(full){ for(const k in achRows) achRows[k].update(); }
    $('#fmt').value=State.number_format; $('#autosave').value=State.autosave_sec; $('#autosavePill').textContent='Autosave: '+State.autosave_sec+'s'; $('#clickInfo').textContent='+ $'+humanize(clickValue())+' / click'; $('#ipoProg').value=prestigeProgress(); }
  function refreshHeader(){
    $('#statFunding').textContent = 'Funding: $ '+humanize(State.funding);
    // Revenue per second (RPS) shown next to funding
    const eps = totalEPS();
    const rpsText = 'RPS: $ '+humanize(eps) + '/s';
    const rEl = document.getElementById('statRPS');
    if(rEl) rEl.textContent = rpsText;
    // keep existing EPS stat for compatibility
    $('#statEPS').textContent = 'EPS: $ '+humanize(eps);
    $('#statRep').textContent = `Rep: ${State.reputation} (x${prestigeMultiplier().toFixed(1)})`;
  }
  function visGen(row,g){ const visible = (State.total_earned>=g.unlockedAt) || (g.owned>0) || (g.unlockedAt===0); if(!row) return; row.el.style.display = visible?'' : 'none'; row.update(); }
  function visUpg(row,u){ 
    if(!row) return;
    if(u.purchased){
      row.el.style.display='none';
    } else {
      // Show upgrade if we can afford 40% of cost OR if requirements are met
      const visible = (State.total_earned >= u.cost*0.4) || upgradeUnlocked(u);
      row.el.style.display = visible ? '' : 'none';
      row.update();
    }
  }

  // Achievements
  // Play a short bip sound using WebAudio
  function playBip(){
    try{
      const AudioCtx = window.AudioContext || window.webkitAudioContext;
      if(!AudioCtx) return;
      const ctx = new AudioCtx();
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.type = 'sine';
      osc.frequency.value = 880; // A5
      gain.gain.value = 0.0001; // start very quiet to avoid click
      osc.connect(gain);
      gain.connect(ctx.destination);
      const now = ctx.currentTime;
      gain.gain.setValueAtTime(0.0001, now);
      gain.gain.exponentialRampToValueAtTime(0.12, now + 0.01);
      osc.start(now);
      gain.gain.exponentialRampToValueAtTime(0.0001, now + 0.18);
      osc.stop(now + 0.2);
      // Close context shortly after (some browsers require user interaction to resume audio anyway)
      setTimeout(()=>{ try{ ctx.close(); }catch{} }, 500);
    }catch(e){/* ignore */}
  }

  function checkAchievements(){
    for(const a of Object.values(State.achs)){
      if(a.achieved) continue;
      const m=a.cond.metric, t=a.cond.threshold; let v=0;
      if(m==='total_earned') v=State.total_earned;
      else if(m==='gpu_owned') v=State.gens.gpu.owned;
      else if(m==='researcher_owned') v=State.gens.researcher.owned;
      else if(m==='reputation') v=State.reputation;
      else if(m==='nebula_owned') v=State.gens.nebula?.owned||0;
      else if(m==='exascale_owned') v=State.gens.exascale?.owned||0;
      else if(m==='global_mesh_owned') v=State.gens.global_mesh?.owned||0;
      else if(m==='community_models_purchased') v=State.upgs.community_models?.purchased?1:0;
      else if(m==='market_domination_purchased') v=State.upgs.market_domination?.purchased?1:0;
      if(v>=t){ a.achieved=true; setStatus('Achievement: '+a.name+' üèÜ'); achRows[a.key]?.update(); try{ playBip(); }catch{} }
    }
  }

  // Status & Save
  let lastSave=performance.now();
  function setStatus(msg){ $('#status').textContent=msg; }
  function serialize(){ return { funding:State.funding, total_earned:State.total_earned, reputation:State.reputation, click_power:State.click_power, number_format:State.number_format, autosave_sec:State.autosave_sec, gens:State.gens, upgs:State.upgs, achs:State.achs }; }
  function deserialize(d){ Object.assign(State,{ funding:d.funding||0, total_earned:d.total_earned||0, reputation:d.reputation||0, click_power:d.click_power||1, number_format:d.number_format||'compact', autosave_sec:d.autosave_sec||30, gens:d.gens||Generators, upgs:d.upgs||Upgrades, achs:d.achs||Achievements }); }
  function save(){ localStorage.setItem('ai_tycoon_web', JSON.stringify(serialize())); lastSave=performance.now(); }
  function saveMaybe(){ if((performance.now()-lastSave)/1000 >= State.autosave_sec) save(); }
  function load(){ const s=localStorage.getItem('ai_tycoon_web'); if(s){ try{ deserialize(JSON.parse(s)); }catch{} } }

  // Init
  load(); refresh(true); requestAnimationFrame(ts=>{ State.lastTick=ts; requestAnimationFrame(loop); });
})();
</script>
</body>
</html>
